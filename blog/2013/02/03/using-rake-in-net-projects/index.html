
<!DOCTYPE html>
<!--[if IEMobile 7 ]>
<html class="no-js iem7"><![endif]-->
<!--[if lt IE 8]>
<html class="no-js lt-ie10 lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if lt IE 9]>
<html class="no-js lt-ie10 lt-ie9" lang="en"> <![endif]-->
<!--[if lt IE 10]><!-->
<html class="no-js" lang="en" xmlns:fb="http://ogp.me/ns/fb#"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>Using Rake in .NET Projects - We are Software Craftsmen</title>
    <meta name="author" content="http://plus.google.com/117652511575279353270?rel=author">

    
    <meta name="description" content="This article will demonstrate how I have utilized Ruby Rake, the Albacore task library, and a few other Ruby gems for build automation in my .NET &hellip;">
    

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10"/>

    
    <link rel="canonical" href="http://softwarecraftsman.github.com/blog/2013/02/03/using-rake-in-net-projects/">
    <link href="/favicon.png" rel="icon">
    <!--[if lt IE 9]>
    <script src="javascripts/html5shiv.js"></script>
    <![endif]-->
    <link href="/stylesheets/bootstrap.min.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/bootstrap-responsive.min.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/app.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
    <script src="/javascripts/bootstrap/bootstrap.min.js" type="text/javascript"></script>
    <script src="/javascripts/twitter.js" type="text/javascript"></script>
    <script src="/javascripts/bitbucket.js" type="text/javascript"></script>
    <script src="/javascripts/github.js" type="text/javascript"></script>
    <!--<script src="/javascripts/app.js" type="text/javascript"></script>-->
    <link href="/atom.xml" rel="alternate" title="We are Software Craftsmen" type="application/atom+xml">
    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
<div class="body">
    <header role="banner"><div class="container">
    <hgroup>
        <h1><a href="/">We are Software Craftsmen</a></h1>
        
    </hgroup>
</div>
</header>
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
        <div class=container>
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".search-collapse">
                <span class="icon-search"></span>
            </a>
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".navigation-collapse">
                <span class="icon-arrow-down"></span>
            </a>

            <nav role="navigation" class="nav-collapse collapse navigation-collapse">
                <ul class="nav">
                    <li>
                        <a title="James Andrew Smith" href="/index.html"><i class="icon-home"></i></a></li>
                    <li class="divider-vertical"></li>
                    <li><a href="/">Blog</a></li>
<li><a href="/blog/archives">Archives</a></li>
<li><a href="/profile">Profile</a></li>
                </ul>
                <ul class="nav subscription" data-subscription="rss">
                    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
                    
                </ul>
            </nav>
            
            <form action="http://google.com/search" method="get" class="nav-collapse collapse search-collapse navbar-search pull-right">
                <fieldset role="search">
                    <input type="hidden" name="q" value="site:softwarecraftsman.github.com"/>
                    <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
                </fieldset>
            </form>
            
        </div>
    </div>
</div>
    <div id="main">
        <div id="content" class="container">
            <div class="row">
                
    <div class="span8">
        
    <article class="hentry" role="article">
      
  <header>
    
      <h1 class="page-header entry-title">Using Rake in .NET Projects
        </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-03T16:36:00-05:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This article will demonstrate how I have utilized Ruby <a href="http://rake.rubyforge.org/">Rake</a>, the <a href="https://github.com/derickbailey/Albacore">Albacore</a> task library, and a few other Ruby gems for build automation in my .NET projects. Hopefully this will be a good source to help those wishing to do the same. Keep in mind that this is not a beginner&#8217;s guide and assumes you are already somewhat familiar with Rake. For those that prefer a more &#8220;hands-on&#8221; approach, the <strong><a href="https://gitlab.wearesoftwarecraftsmen.com/public">source code</a></strong> for this article can be found with my other <a href="https://gitlab.wearesoftwarecraftsmen.com/public">public projects</a>. <!--More--> </p>

<h2 id="the-goals">The Goals</h2>
<p>Before writing any Ruby, it&#8217;s important to determine exactly what it is you are trying to automate with Rake. This will serve as a guide in what and how you write your Rake tasks. I set out with the following goals in mind:</p>

<ul>
  <li>Compile the .NET project</li>
  <li>Run all <a href="/blog/2013/01/19/getting-started-with-mspec-machine-dot-specifications/">Mspec test specifications</a> for  project
    <ul>
      <li>Fail the build if any test specifications do not pass</li>
    </ul>
  </li>
  <li>Generate AssemblyInfo.cs files with project information and version number
    <ul>
      <li>Include the commit sha with the version information in the AssemblyInfo.cs file</li>
    </ul>
  </li>
  <li>Pull current version from git source control</li>
  <li>Be able to increment a major and minor version for a build</li>
  <li>Output all project <abbr title="Dynamic Link Library">DLL</abbr>s <strong>not</strong> associated with specification tests to build and release output folders</li>
  <li>Be able to optionally merge all project <abbr title="Dynamic Link Library">DLL</abbr>s <strong>not</strong> associated with specification tests into one <abbr title="Dynamic Link Library">DLL</abbr> for distribution</li>
  <li>Optionally be able to tag the current version in git from the build</li>
</ul>

<h2 id="include-our-gems">Include our Gems</h2>
<p>We will want to include our gems and any Ruby file in the <code>build_tools</code> folder:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">require</span> <span class="s2">&quot;rake&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;albacore&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;fileutils&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;grit&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;configatron&quot;</span>
</span><span class="line"><span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;./build_tools/*rb&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">include_file</span><span class="o">|</span>
</span><span class="line">	<span class="nb">require</span> <span class="n">include_file</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="preparing-the-build">Preparing the Build</h2>
<p>Next, the build script needs to define some common properties and clean up the solution from any previous build. To facilitate cleaning the build, I have created a Rake namespace called <code>:setup</code>. In this namespace I have three tasks for now; one to remove any build-created directories, one to re-create any directories needed by the build, and, finally, one to call that completes all setup tasks (there will be a few more shortly).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">base_dir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class="line"><span class="n">build_tools_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/build_tools&quot;</span>
</span><span class="line"><span class="n">build_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/build&quot;</span>
</span><span class="line"><span class="n">namespace</span> <span class="ss">:setup</span> <span class="k">do</span>
</span><span class="line">
</span><span class="line">	<span class="n">desc</span> <span class="s2">&quot;Cleans up and removes build related artifacts.&quot;</span>
</span><span class="line">	<span class="n">task</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class="line">		<span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span> <span class="n">build_dir</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">	
</span><span class="line">	<span class="n">desc</span> <span class="s2">&quot;Initializes directories&quot;</span>
</span><span class="line">	<span class="n">task</span> <span class="ss">:init_directories</span> <span class="o">=&gt;</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class="line">		<span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir</span> <span class="n">build_dir</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">	
</span><span class="line">	<span class="n">desc</span> <span class="s2">&quot;Prepares files/folders/etc. for a new build.&quot;</span>
</span><span class="line">	<span class="n">task</span> <span class="ss">:init</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:init_directories</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="compiling-the-project">Compiling the Project</h2>
<p>For the compilation task, I used <a href="https://github.com/derickbailey/Albacore">Albacore</a>&#8217;s <code>msbuild</code> task.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Compiles the project.&quot;</span>
</span><span class="line"><span class="n">msbuild</span> <span class="ss">:compile</span> <span class="o">=&gt;</span> <span class="s2">&quot;setup:init&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">msb</span><span class="o">|</span>
</span><span class="line">	<span class="n">msb</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_tools_dir</span><span class="si">}</span><span class="s2">/msbuild/msbuild.exe&quot;</span>
</span><span class="line">	<span class="n">msb</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:configuration</span> <span class="o">=&gt;</span> <span class="ss">:Release</span><span class="p">}</span>
</span><span class="line">	<span class="n">msb</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:Clean</span><span class="p">,</span> <span class="ss">:Build</span><span class="o">]</span>
</span><span class="line">	<span class="n">msb</span><span class="o">.</span><span class="n">nologo</span>
</span><span class="line">	<span class="n">msb</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">target_solution_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I have stored my target solution file in an external configuration file and used the <a href="https://github.com/markbates/configatron">configatron</a> gem to make it available. In order to do this, I have created a <code>build_configuration.settings</code> file:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">configatron</span><span class="o">.</span><span class="n">configure_from_hash</span> <span class="ss">:settings</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class="line">	<span class="ss">:target_solution_file</span> <span class="o">=&gt;</span> <span class="s2">&quot;DomainFramework.sln&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="ss">:title</span><span class="o">=&gt;</span> <span class="s2">&quot;Domain Framework&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="ss">:description</span><span class="o">=&gt;</span> <span class="s2">&quot;Framework to facilitate domain-oriented development in .NET.&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="ss">:company</span><span class="o">=&gt;</span> <span class="s2">&quot;We are Software Craftsmen&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="ss">:product</span><span class="o">=&gt;</span> <span class="s2">&quot;Domain Framework&quot;</span><span class="p">,</span>
</span><span class="line">	<span class="ss">:copyright</span> <span class="o">=&gt;</span> <span class="s2">&quot;We are Software Craftsmen &amp; Andrew Smith 2013&quot;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Notice that this is simply a Ruby file with a different file extension. I then load this file in the beginning with my other common variable declarations at the top; giving me:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">load</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/build_configuration.settings&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>msbuild</code> task uses the default location of the MSBuild executable. However, there is a chance the build machine does not have MSBuild in the correct location or even installed. In order to make the build self-contained, I have explicitly configured the task&#8217;s command location to use the MSBuild.exe located in my build_tools directory. The MSBuild executable can be copied from the following locations:</p>

<p>64-bit <code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe</code></p>

<p>32-bit <code>C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe</code></p>

<h2 id="execute-mspec-specification-tests">Execute MSpec Specification Tests</h2>
<p>Utilizing the specialized <code>mspec</code> <a href="https://github.com/derickbailey/Albacore">Albacore</a> task makes this easy:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Executes all Mspec specifications.&quot;</span>
</span><span class="line"><span class="n">mspec</span> <span class="ss">:test</span> <span class="o">=&gt;</span> <span class="ss">:compile</span> <span class="k">do</span> <span class="o">|</span><span class="n">mspec</span><span class="o">|</span>
</span><span class="line">	<span class="n">spec_dlls</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.Specs.dll&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="n">spec_dlls</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class="line">		<span class="n">mspec</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_tools_dir</span><span class="si">}</span><span class="s2">/mspec/mspec-clr4.exe&quot;</span>
</span><span class="line">		<span class="n">mspec</span><span class="o">.</span><span class="n">assemblies</span> <span class="o">=</span> <span class="n">spec_dlls</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I have the convention that all my Mspec assemblies will end with <code>.Specs.dll</code>, so the first thing it does is scan the project for any <abbr title="Dynamic Link Library">DLL</abbr>s that match that pattern. If it finds any, then it executes the mspec command. Notice that I am specifying the Mspec executable as being located in my <code>build_tools/mspec</code> folder. You will need to build Mspec from its <a href="https://github.com/machine/machine.specifications">source</a> and add the built executable and assemblies to this folder.</p>

<h2 id="versioning">Versioning</h2>
<p>To manage the versioning, I created a Ruby class, <code>Version</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Version</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span class="line">		<span class="vi">@repo</span> <span class="o">=</span> <span class="n">repo</span>
</span><span class="line">		<span class="vi">@already_incremented</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class="line">		<span class="vi">@major_version</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">		<span class="vi">@minor_version</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">		<span class="vi">@commit_id</span> <span class="o">=</span> <span class="vi">@repo</span><span class="o">.</span><span class="n">commits</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">id</span>
</span><span class="line">		<span class="n">latest_tag</span> <span class="o">=</span> <span class="vi">@repo</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="sr">/^v/</span> <span class="o">=~</span> <span class="n">tag</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort_by!</span> <span class="p">{</span><span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="n">tag</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">authored_date</span> <span class="p">}</span><span class="o">.</span><span class="n">last</span>
</span><span class="line">		<span class="k">if</span> <span class="o">!</span><span class="n">latest_tag</span><span class="o">.</span><span class="n">nil?</span> <span class="k">then</span>
</span><span class="line">			<span class="nb">puts</span> <span class="n">latest_tag</span><span class="o">.</span><span class="n">name</span>
</span><span class="line">			<span class="n">version_parts</span> <span class="o">=</span> <span class="n">latest_tag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">sub!</span><span class="p">(</span><span class="sr">/^v/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span class="line">			<span class="vi">@major_version</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="n">version_parts</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">			<span class="vi">@minor_version</span> <span class="o">=</span> <span class="nb">Integer</span><span class="p">(</span><span class="n">version_parts</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">increment_version</span><span class="p">(</span><span class="n">release_type</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="o">!</span><span class="vi">@already_incremented</span> <span class="k">then</span>
</span><span class="line">			<span class="vi">@already_incremented</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">			<span class="k">if</span> <span class="n">release_type</span> <span class="o">==</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">major</span> <span class="k">then</span>
</span><span class="line">				<span class="n">increment_major</span>
</span><span class="line">			<span class="k">elsif</span> <span class="n">release_type</span> <span class="o">==</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">minor</span>
</span><span class="line">				<span class="n">increment_minor</span>
</span><span class="line">			<span class="k">end</span>
</span><span class="line">			<span class="k">return</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">		<span class="kp">throw</span> <span class="ss">:alreadyIncremented</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="n">with_commit_id</span> <span class="o">=</span> <span class="kp">false</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="n">with_commit_id</span> <span class="k">then</span>
</span><span class="line">			<span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@major_version</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="vi">@minor_version</span><span class="si">}#{</span><span class="vi">@commit_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">		<span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@major_version</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="vi">@minor_version</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="kp">private</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">increment_major</span>
</span><span class="line">		<span class="vi">@minor_version</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">		<span class="vi">@major_version</span> <span class="o">=</span> <span class="vi">@major_version</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">increment_minor</span>
</span><span class="line">		<span class="vi">@minor_version</span> <span class="o">=</span> <span class="vi">@minor_version</span> <span class="o">+</span> <span class="mi">1</span>	
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It accepts a <a href="https://github.com/mojombo/grit">grit</a> repository object and defaults to version 0.1 (major.minor). From the repo object, it then pulls a sorted collection of tags and grabs the most recent tag matching the name <code>v*.*</code>; so for example <code>v0.1</code>. It then takes this tag and splits it into the major and minor version.</p>

<p>There is also a <code>toString</code> method for formatting the version in the format major.minor; with the optional setting to include the git commit sha at the end for major.minor.sha. Finally, we have an <code>increment_version</code> method that will increment the version based appropriately on the release type of major, minor, or ci. I did not want to use a magic string for the release type, so I also created another Ruby class to manage this; <code>ReleaseType</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">ReleaseType</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span class="line">		<span class="vi">@type</span> <span class="o">=</span> <span class="n">type</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="vc">@@major</span> <span class="o">=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;major&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="vc">@@minor</span> <span class="o">=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="vc">@@ci</span> <span class="o">=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;ci&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nf">type</span>
</span><span class="line">		<span class="k">return</span> <span class="vi">@type</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_string</span><span class="p">(</span><span class="n">release_type</span><span class="p">)</span>
</span><span class="line">		<span class="k">if</span> <span class="n">release_type</span> <span class="o">==</span> <span class="s2">&quot;major&quot;</span> <span class="k">then</span>
</span><span class="line">			<span class="k">return</span> <span class="vc">@@major</span>
</span><span class="line">		<span class="k">elsif</span> <span class="n">release_type</span> <span class="o">==</span> <span class="s2">&quot;minor&quot;</span>
</span><span class="line">			<span class="k">return</span> <span class="vc">@@minor</span>
</span><span class="line">		<span class="k">elsif</span> <span class="n">release_type</span> <span class="o">==</span> <span class="s2">&quot;ci&quot;</span>
</span><span class="line">			<span class="k">return</span> <span class="vc">@@ci</span>
</span><span class="line">		<span class="k">end</span>
</span><span class="line">		<span class="k">return</span> <span class="vc">@@ci</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">major</span>
</span><span class="line">		<span class="k">return</span> <span class="vc">@@major</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">minor</span>
</span><span class="line">		<span class="k">return</span> <span class="vc">@@minor</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">ci</span>
</span><span class="line">		<span class="k">return</span> <span class="vc">@@ci</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This class defines a string property for the type&#8217;s name and then three class properties for each of the release types; major, minor, and ci. It also has a class method to return a release type based on a passed string. With this, we need to add a few more common properties to our rakefile as seen below:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1">#...</span>
</span><span class="line">
</span><span class="line"><span class="n">release_type_input</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;release_type&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;ci&quot;</span>
</span><span class="line"><span class="n">release_type</span> <span class="o">=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">release_type_input</span><span class="p">)</span>
</span><span class="line"><span class="n">repo</span> <span class="o">=</span> <span class="ss">Grit</span><span class="p">:</span><span class="ss">:Repo</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
</span><span class="line"><span class="n">version</span> <span class="o">=</span> <span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Notice that I am using the <a href="https://github.com/mojombo/grit">grit</a> Ruby gem and creating one stating that our project root is the git repository.</p>

<h2 id="updating-the-assemblyinfocs-with-our-version">Updating the AssemblyInfo.cs with our Version</h2>
<p>We may have a mechanism in place for maintaining our version, but currently we are not actually using this version number anywhere. What we would like is for the build to automatically generate any required <code>AssemblyInfo.cs</code> with our information and version upon being built. I have added a few tasks in the <code>setup</code> namespace and modified our <code>init</code> task to utilize them:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Updates assembly info files.&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:update_assemblies</span> <span class="k">do</span>
</span><span class="line">	<span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*/Properties/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">folder</span><span class="o">|</span>
</span><span class="line">		<span class="p">(</span><span class="n">assemblyinfo</span> <span class="n">folder</span> <span class="k">do</span> <span class="o">|</span><span class="n">asm</span><span class="o">|</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">toString</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">company_name</span> <span class="o">=</span> <span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">company_name</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">product</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">title</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">description</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">copyright</span> <span class="o">=</span> <span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">copyright</span>
</span><span class="line">			<span class="n">asm</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/AssemblyInfo.cs&quot;</span>
</span><span class="line">		<span class="k">end</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span>
</span><span class="line">	<span class="p">}</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">desc</span> <span class="s2">&quot;Increments version&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:increment_version</span> <span class="k">do</span>
</span><span class="line">	<span class="n">version</span><span class="o">.</span><span class="n">increment_version</span><span class="p">(</span><span class="n">release_type</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1">#...</span>
</span><span class="line">
</span><span class="line"><span class="n">desc</span> <span class="s2">&quot;Prepares files/folders/etc. for a new build.&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:init</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:init_directories</span><span class="p">,</span> <span class="ss">:increment_version</span><span class="p">,</span> <span class="ss">:update_assemblies</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Notice that an <code>AssemblyInfo.cs</code> file is created in every <code>Properties</code> folder two levels below the root; first level being the <code>csproj</code>/<code>vbproj</code> folder and the second being its contained <code>Properties</code> folder. I am using the <code>assemblyinfo</code> <a href="https://github.com/derickbailey/Albacore">Albacore</a> task and my data is being set from my configuration file.</p>

<h2 id="build-output">Build Output</h2>
<p>Currently the <code>msbuild</code> task is building all our projects in place and not outputing the assemblies anywhere useful. We remedy this by creating another task responsible for moving all the built Release assemblies. These assemblies will be copied to a temporary folder to be processed further by the build script. We do not, however, want to copy any test releated assemblies or dependent assemblies. To faciliate this, I have added a <code>project_folders</code> property at the top of the rakefile that contains only project folders not affiliated with testing.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">rejectFolders</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;release&quot;</span><span class="p">,</span> <span class="s2">&quot;build_tools&quot;</span><span class="p">,</span> <span class="s2">&quot;packages&quot;</span><span class="o">]</span>
</span><span class="line"><span class="n">project_folders</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_dir</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">folder</span><span class="o">|</span>
</span><span class="line">					<span class="n">rejectFolders</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class="line">						<span class="sr">/.*</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="sr">/</span> <span class="o">=~</span> <span class="n">folder</span>
</span><span class="line">					<span class="p">}</span> <span class="o">||</span>
</span><span class="line">					<span class="sr">/.*Specs.*/</span> <span class="o">=~</span> <span class="n">folder</span> <span class="o">||</span>
</span><span class="line">					<span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">directory?</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span><span class="line">				<span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c1">#...</span>
</span><span class="line">
</span><span class="line"><span class="n">desc</span> <span class="s2">&quot;Copies project output to build folder.&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:build_output</span> <span class="o">=&gt;</span> <span class="s2">&quot;setup:init_directories&quot;</span> <span class="k">do</span>
</span><span class="line">	<span class="n">project_folders</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">folder</span><span class="o">|</span>
</span><span class="line">	 	<span class="no">FileUtils</span><span class="o">.</span><span class="n">cp_r</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">folder</span><span class="si">}</span><span class="s2">/bin/Release/.&quot;</span><span class="p">,</span> <span class="n">build_dir</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I also create a new namespace, <code>release</code>, and add tasks for preparing for the build&#8217;s output.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">namespace</span> <span class="ss">:release</span> <span class="k">do</span>
</span><span class="line">	<span class="n">desc</span> <span class="s2">&quot;Cleans for new release.&quot;</span>
</span><span class="line">	<span class="n">task</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class="line">		<span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_rf</span> <span class="n">release_dir</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">
</span><span class="line">	<span class="n">task</span> <span class="ss">:init</span> <span class="o">=&gt;</span> <span class="ss">:clean</span> <span class="k">do</span>
</span><span class="line">		<span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir</span> <span class="n">release_dir</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, I add a task to the <code>release</code> namespace to copy all assemblies from the temporary build folder into a release folder. This will be used when no merging of assemblies is required:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Output the build&amp;#8217;s release output.&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:output</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:test</span><span class="p">,</span> <span class="ss">:build_output</span><span class="p">,</span> <span class="ss">:init</span><span class="o">]</span> <span class="k">do</span>
</span><span class="line">	<span class="no">FileUtils</span><span class="o">.</span><span class="n">cp</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_dir</span><span class="si">}</span><span class="s2">/*.dll&quot;</span><span class="p">),</span> <span class="n">release_dir</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="merging-assemblies">Merging Assemblies</h2>
<p>In the case we want to merge all our assemblies into one to be output, we can use a tool called IL Merge. IL Merge is a tool which takes multiple .NET assemblies and combines them into one assembly <abbr title="Dynamic Link Library">DLL</abbr>. The ILMerge installer can be downloaded from <a href="http://www.microsoft.com/en-us/download/details.aspx?id=17630">Microsoft</a>. Once installed, you will need locate the ILMerge.exe file and add it to your <code>build_tools</code> directory.</p>

<p>I have added a task, <code>merge_and_output</code>, to the <code>release</code> namespace that utilizes the <code>ilmerge</code> <a href="https://github.com/derickbailey/Albacore">Albacore</a> task.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Merge built assemblies.&quot;</span>
</span><span class="line"><span class="n">ilmerge</span> <span class="ss">:merge_and_output</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:test</span><span class="p">,</span> <span class="ss">:build_output</span><span class="p">,</span><span class="ss">:init</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">cfg</span><span class="o">|</span>
</span><span class="line">	<span class="n">assemblies</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_dir</span><span class="si">}</span><span class="s2">/*.dll&quot;</span><span class="p">)</span>
</span><span class="line">	<span class="n">cfg</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">build_tools_dir</span><span class="si">}</span><span class="s2">/ilmerge/ILMerge.exe&quot;</span>
</span><span class="line">	<span class="n">cfg</span><span class="o">.</span><span class="n">assemblies</span> <span class="n">assemblies</span>
</span><span class="line">	<span class="n">cfg</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">release_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">configatron</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">.Release.dll&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Because only non-test releated assemblies have been copied to the build output folder, we can simply take every assembly in the folder and merge them together. I am outputing the merged assembly to the release directory.</p>

<h2 id="tagging-our-version-in-git">Tagging our Version in Git</h2>
<p>The last task I need to create is one to tag a release in git. I created a <code>ReleaseManager</code> class to handle this functionality. It contains a single class level method that creates a tag based on the version and release type.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">ReleaseManager</span>
</span><span class="line">	<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">tag_release</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">release_type</span><span class="p">)</span>
</span><span class="line">		<span class="nb">exec</span> <span class="s2">&quot;git tag -a </span><span class="se">\&quot;</span><span class="s2">v</span><span class="si">#{</span><span class="n">version</span><span class="o">.</span><span class="n">toString</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> -m </span><span class="se">\&quot;</span><span class="s2">Tagged for </span><span class="si">#{</span><span class="n">release_type</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">: v</span><span class="si">#{</span><span class="n">version</span><span class="o">.</span><span class="n">toString</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I then use this class in my final rake task located in the release namespace. If the release type is not a minor or major release, an error is thrown.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">desc</span> <span class="s2">&quot;Tags current version.&quot;</span>
</span><span class="line"><span class="n">task</span> <span class="ss">:tag_release</span> <span class="o">=&gt;</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class="line">	<span class="k">if</span> <span class="n">release_type</span> <span class="o">!=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">minor</span> <span class="o">||</span> <span class="n">release_type</span> <span class="o">!=</span> <span class="no">ReleaseType</span><span class="o">.</span><span class="n">major</span> <span class="k">then</span>
</span><span class="line">		<span class="kp">throw</span> <span class="ss">:releaseTypeNotSupported</span>
</span><span class="line">	<span class="k">end</span>
</span><span class="line">	<span class="no">ReleaseManager</span><span class="o">.</span><span class="n">tag_release</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">release_type</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, I add my default rake task to simply build the project and release its output without merging or tagging.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s2">&quot;release:output&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="conclusion">Conclusion</h2>
<p>Using Ruby Rake we have successfully written a build automation script that can be used with most .NET projects; configurable by an external settings file. Of course, the full source can be pull via git from my <a href="https://gitlab.wearesoftwarecraftsmen.com/public">public repositories</a>. Feel free to leave your comments and questions. As always, remember that we all are software craftsmen!</p>
</div>


      <footer>
        <p class="meta">
          
  

<span class="byline author vcard">Posted by <a rel="me" href="/profile" class="fn">Andrew Smith</a></span>

          








  


<time datetime="2013-02-03T16:36:00-05:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2013</time>
          

<span class="categories">
  
    <a class='category' href='/blog/categories/automation/'>automation</a>, <a class='category' href='/blog/categories/rake/'>rake</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


        </p>
        
          <div class="sharing">
    
    <script type="IN/Share" data-url="http://softwarecraftsman.github.com//blog/2013/02/03/using-rake-in-net-projects/" data-counter="right" data-onsuccess="LinkedInShare"></script>
    
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://softwarecraftsman.github.com/blog/2013/02/03/using-rake-in-net-projects/" data-via="software_craft" data-counturl="http://softwarecraftsman.github.com/blog/2013/02/03/using-rake-in-net-projects/" >Tweet</a>
  

  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <!--<div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>-->
    <fb:like send="true" width="450" show_faces="true"></fb:like>
  
</div>

        
        <p class="meta">
          
            <a class="basic-alignment left" href="/blog/2013/01/28/on-software-craftsmanship/" title="Previous Post: On Software Craftsmanship">&laquo; On Software Craftsmanship</a>
          
          
            <a class="basic-alignment right" href="/blog/2013/02/06/adding-related-posts-to-octopress-on-windows/" title="Next Post: Adding Related Posts to Octopress on Windows">Adding Related Posts to Octopress on Windows &raquo;</a>
          
        </p>
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
</div>

<div class="span4">
    <aside class="sidebar">
      
        <section>
  <h1>About Me</h1>
  <p><img class="img-polaroid pull-right" src="/images/profile_headshot_125x125.png" title="Profile headshot" >
      I am a software engineer and am passionate about the craft in which I work. My interests are wide and varied; ranging from software architecture to UI/UX for the web. I am a strong subscriber to the <abbr title="A set of five principles of object-oriented design">SOLID</abbr> principles and am in constant pursuit of improvement. This site is dedicated to my thoughts, my work and the craft of making quality software.</p>
</section>
<section>
    <h1>Related Posts</h1>
    <ul class="related_posts unstyled">
        
        <li class="post">
            <a href="/blog/2013/01/19/getting-started-with-mspec-machine-dot-specifications/">Get Started with MSpec</a>
        </li>
        
        <li class="post">
            <a href="/blog/2013/02/06/adding-related-posts-to-octopress-on-windows/">Adding Related Posts to Octopress on Windows</a>
        </li>
        
        <li class="post">
            <a href="/blog/2013/01/28/on-software-craftsmanship/">On Software Craftsmanship</a>
        </li>
        
    </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts" class="unstyled">
    
      <li class="post">
        <a href="/blog/2013/02/06/adding-related-posts-to-octopress-on-windows/">Adding Related Posts to Octopress on Windows</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/03/using-rake-in-net-projects/">Using Rake in .NET Projects</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/28/on-software-craftsmanship/">On Software Craftsmanship</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/19/getting-started-with-mspec-machine-dot-specifications/">Get Started with MSpec</a>
      </li>
    
  </ul>
</section>
<section class="tag-cloud">
  <h1>Tag Cloud</h1>
    <nav><a href='/blog/categories/automation' style='font-size: 130.0%'>automation(1)</a> <a href='/blog/categories/bdd' style='font-size: 130.0%'>BDD(1)</a> <a href='/blog/categories/craftsmanship' style='font-size: 130.0%'>craftsmanship(1)</a> <a href='/blog/categories/mspec' style='font-size: 130.0%'>mspec(1)</a> <a href='/blog/categories/octopress' style='font-size: 130.0%'>octopress(1)</a> <a href='/blog/categories/rake' style='font-size: 130.0%'>rake(1)</a> <a href='/blog/categories/ruby' style='font-size: 160.0%'>ruby(2)</a> <a href='/blog/categories/tdd' style='font-size: 130.0%'>TDD(1)</a> <a href='/blog/categories/unit-testing' style='font-size: 130.0%'>unit testing(1)</a> </nav>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets" class="unstyled">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $(function(){
      getTwitterFeed("software_craft", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/software_craft" class="twitter-follow-button" data-show-count="false">Follow @software_craft</a>
  
</section>


<section id="github">
  <h1>GitHub Repos</h1>
  <ul id="github_repos" class="unstyled">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/softwarecraftsman">@softwarecraftsman</a> on GitHub
  
  <script type="text/javascript">
    $(function(){
        github.showRepos({
            user: 'softwarecraftsman',
            count: 5,
            skip_forks: true,
            target: '#github_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section id="bitbucket">
  <h1>Bitbucket Repos</h1>
  <ul id="bitbucket_repos" class="unstyled">
    <li class="loading">Status updating...</li>
  </ul>
  
  <script type="text/javascript">
    $(function(){
        bitbucket.showRepos({
            user: 'wearesoftwarecraftsmen',
            count: 5,
            target: '#bitbucket_repos'
        });
    });
  </script>
  <script src="/javascripts/bitbucket.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/117652511575279353270?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



      
    </aside>
</div>

            </div>
        </div>
    </div>
    <footer role="contentinfo"><div class="container"><div>
    <p>
        Copyright &copy; 2013 - Andrew Smith -
        <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
    </p>
</div>
</div></footer>
    

<script type="text/javascript">
      var disqus_shortname = 'wearesoftwarecraftsmen';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://softwarecraftsman.github.com/blog/2013/02/03/using-rake-in-net-projects/';
        var disqus_url = 'http://softwarecraftsman.github.com/blog/2013/02/03/using-rake-in-net-projects/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<div id="fb-root"></div>
	<script>
		window.fbAsyncInit = function() {
		    FB.init({
		      // appId      : 'YOUR_APP_ID', // App ID
		      // channelUrl : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
		      status     : true,
		      cookie     : true,
		      xfbml      : true
		    });
		    FB.Event.subscribe('edge.create', function(targetUrl) {
		      _gaq.push(['_trackSocial', 'facebook', 'like', targetUrl]);
		    });
		    FB.Event.subscribe('edge.remove', function(targetUrl) {
		      _gaq.push(['_trackSocial', 'facebook', 'unlike', targetUrl]);
		    });
		    FB.Event.subscribe('message.send', function(targetUrl) {
		      _gaq.push(['_trackSocial', 'facebook', 'send', targetUrl]);
		    });
		  };

		(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    window.twttr = (function (d,s,id) {
      var t, js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
      js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
      return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
    }(document, "script", "twitter-wjs"));
  </script>



<script src="//platform.linkedin.com/in.js" type="text/javascript"></script>
<script type="text/javascript">
	function LinkedInShare() {
	_gaq.push(['_trackSocial', 'LinkedIn', 'Share']);
	}
</script>


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38417885-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    function extractParamFromUri(uri, paramName) {
      if (!uri) {
        return;
      }
      var regex = new RegExp('[\\?&#]' + paramName + '=([^&#]*)');
      var params = regex.exec(uri);
      if (params != null) {
        return unescape(params[1]);
      }
      return;
    }
    function trackTwitter(intent_event) {
      if (intent_event) {
        var opt_pagePath;
        if (intent_event.target && intent_event.target.nodeName == 'IFRAME') {
              opt_target = extractParamFromUri(intent_event.target.src, 'url');
        }
        _gaq.push(['_trackSocial', 'twitter', 'tweet', opt_pagePath]);
      }
    }
  </script>



</div>
</body>
</html>
